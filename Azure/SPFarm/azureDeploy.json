// Azure Deployment Template
// Create SharePoint 2013 Farm
// Consists of a single WFE, single APP, and single SQL server.
{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"adminUsername": {
			"type": "string",
			"defaultValue": "rgarrett",
			"metadata": {
				"description": "Admin username"
			}
		},
		"adminPassword": {
			"type": "securestring",
			"defaultValue": "Pa$$w0rd1",
			"metadata": {
				"description": "Admin password"
			}
		},
		"imagePublisher": {
			"type": "string",
			"defaultValue": "MicrosoftWindowsServer",
			"metadata": {
				"description": "Image Publisher"
			}
		},
		"imageOffer": {
			"type": "string",
			"defaultValue": "WindowsServer",
			"metadata": {
				"description": "Image Offer"
			}
		},
		"imageSKU": {
			"type": "string",
			"defaultValue": "2012-R2-Datacenter",
			"allowedValues": [
				"2008-R2-SP1",
				"2012-Datacenter",
				"2012-R2-Datacenter"
			],
			"metadata": {
				"description": "Image SKU"
			}
		},
		"vmSizeSharePoint": {
			"type": "string",
			"defaultValue": "Standard_D2_V2",
			"metadata": {
				"description": "Size of the VM for SharePoint"
			}
		},
		"vmSizeSQL": {
			"type": "string",
			"defaultValue": "Standard_D3_V2",
			"metadata": {
				"description": "Size of the VM for SQL"
			}
		},
		"dnsNameforSharePoint": {
			"type": "string",
			"defaultValue": "[concat('sp-', toLower(replace(resourceGroup().name, ' ', '')), '-rdglab')]",
			"metadata": {
				"description": "Public DNS name for SharePoint Farm"
			}
		},
		"Subnet": {
			"type": "string",
			"defaultValue": "10.0.0.0/24",
			"metadata": {
				"description": "Subnet Address"
			}
		},
		"vnetAddressPrefix": {
			"type": "string",
			"defaultValue": "10.0.0.0/16",
			"metadata": {
				"description": "VNET Address Prefix"
			}
		}
	},
	"variables": {
		// Build variables based on the resource name.
		"commonID": "[toLower(replace(resourceGroup().name, ' ', ''))]",
		"storageAccount": {
			"storageAccountName": "[concat('rdglab', variables('commonID'))]"
		},
		"Networking": {
			"vnetName": "[concat(variables('commonID'), '-vnet')]",
			"subnetName": "[concat(variables('commonID'), '-subnet')]",
			"subnet": "[parameters('Subnet')]",
			"spWebNicName": "[concat(variables('commonID'), '-spwebnic')]",
			"spAppNicName": "[concat(variables('commonID'), '-spappnic')]",
			"sqlNicName": "[concat(variables('commonID'), '-sqlnic')]",
			"spPublicIPAddressName": "[concat(variables('commonID'), '-sppip')]"
		},
		"Compute": {
			"sqlServer": "[concat(variables('commonID'), '-sql')]",
			"spWebServer": "[concat(variables('commonID'), '-wfe')]",
			"spAppServer": "[concat(variables('commonID'), '-app')]"
		}
	},
	"resources": [
		// Storage Account
		{
			"type": "Microsoft.Storage/storageAccounts",
			"name": "[variables('storageAccount').storageAccountName]",
			"apiVersion": "2015-06-15",
			"location": "[resourceGroup().location]",
			"properties": {
				"accountType": "Standard_LRS"
			}
		},
		// Public IP Addresses
		/// SharePoint WFE
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Network/publicIPAddresses",
			"name": "[variables('Networking').spPublicIPAddressName]",
			"location": "[resourceGroup().location]",
			"properties": {
				"publicIPAllocationMethod": "Dynamic",
				"dnsSettings": {
					"domainNameLabel": "[parameters('dnsNameforSharePoint')]"
				}
			}
		},
		// Virtual Network and Subnets
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Network/virtualNetworks",
			"name": "[variables('Networking').vnetName]",
			"location": "[resourceGroup().location]",
			"properties": {
				"addressSpace": {
					"addressPrefixes": [
						"[parameters('vnetAddressPrefix')]"
					]
				},
				"subnets": [
					{
						"name": "[variables('Networking').subnetName]",
						"properties": {
							"addressPrefix": "[variables('Networking').subnet]"
						}
					}
				]
			}
		},
		// Network Cards
		//// SQL Server
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Network/networkInterfaces",
			"name": "[variables('Networking').sqlNicName]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Network/virtualNetworks/', variables('Networking').vnetName)]"
			],
			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig",
						"properties": {
							"privateIPAllocationMethod": "Dynamic",
							"subnet": {
								"id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('Networking').vnetName),'/subnets/',variables('Networking').subnetName)]"
							}
						}
					}
				]
			}
		},
		//// SharePoint APP
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Network/networkInterfaces",
			"name": "[variables('Networking').spAppNicName]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Network/virtualNetworks/', variables('Networking').vnetName)]"
			],
			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig",
						"properties": {
							"privateIPAllocationMethod": "Dynamic",
							"subnet": {
								"id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('Networking').vnetName),'/subnets/',variables('Networking').subnetName)]"
							}
						}
					}
				]
			}
		},
		//// SharePoint WFE
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Network/networkInterfaces",
			"name": "[variables('Networking').spWebNicName]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Network/virtualNetworks/', variables('Networking').vnetName)]",
				"[concat('Microsoft.Network/publicIPAddresses/', variables('Networking').spPublicIPAddressName)]"
			],
			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig",
						"properties": {
							"publicIPAddress": {
								"id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('Networking').spPublicIPAddressName)]"
							},
							"privateIPAllocationMethod": "Dynamic",
							"subnet": {
								"id": "[concat(resourceId('Microsoft.Network/virtualNetworks', variables('Networking').vnetName),'/subnets/',variables('Networking').subnetName)]"
							}
						}
					}
				]
			}
		},
		// Virtual Machines
		//// SQL Server
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[variables('Compute').sqlServer]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Storage/storageAccounts/', variables('storageAccount').storageAccountName)]",
				"[concat('Microsoft.Network/networkInterfaces/', variables('Networking').sqlNicName)]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('vmSizeSQL')]"
				},
				"osProfile": {
					"computerName": "[variables('Compute').sqlServer]",
					"adminUsername": "[parameters('adminUsername')]",
					"adminPassword": "[parameters('adminPassword')]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[parameters('imagePublisher')]",
						"offer": "[parameters('imageOffer')]",
						"sku": "[parameters('imageSKU')]",
						"version": "latest"
					},
					"osDisk": {
						"name": "osdisk",
						"vhd": {
							"uri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net/vhds/','sql-osdisk.vhd')]"
						},
						"caching": "ReadWrite",
						"createOption": "FromImage"
					}
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Networking').sqlNicName)]"
						}
					]
				},
				"diagnosticsProfile": {
					"bootDiagnostics": {
						"enabled": "true",
						"storageUri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net')]"
					}
				}
			}
		},
		//// SharePoint Web
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[variables('Compute').spWebServer]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Storage/storageAccounts/', variables('storageAccount').storageAccountName)]",
				"[concat('Microsoft.Network/networkInterfaces/', variables('Networking').spWebNicName)]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('vmSizeSharePoint')]"
				},
				"osProfile": {
					"computerName": "[variables('Compute').spWebServer]",
					"adminUsername": "[parameters('adminUsername')]",
					"adminPassword": "[parameters('adminPassword')]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[parameters('imagePublisher')]",
						"offer": "[parameters('imageOffer')]",
						"sku": "[parameters('imageSKU')]",
						"version": "latest"
					},
					"osDisk": {
						"name": "osdisk",
						"vhd": {
							"uri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net/vhds/','spweb-osdisk.vhd')]"
						},
						"caching": "ReadWrite",
						"createOption": "FromImage"
					}
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Networking').spwebNicName)]"
						}
					]
				},
				"diagnosticsProfile": {
					"bootDiagnostics": {
						"enabled": "true",
						"storageUri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net')]"
					}
				}
			}
		},
		//// SharePoint App
		{
			"apiVersion": "2015-06-15",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[variables('Compute').spAppServer]",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[concat('Microsoft.Storage/storageAccounts/', variables('storageAccount').storageAccountName)]",
				"[concat('Microsoft.Network/networkInterfaces/', variables('Networking').spAppNicName)]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('vmSizeSharePoint')]"
				},
				"osProfile": {
					"computerName": "[variables('Compute').spAppServer]",
					"adminUsername": "[parameters('adminUsername')]",
					"adminPassword": "[parameters('adminPassword')]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[parameters('imagePublisher')]",
						"offer": "[parameters('imageOffer')]",
						"sku": "[parameters('imageSKU')]",
						"version": "latest"
					},
					"osDisk": {
						"name": "osdisk",
						"vhd": {
							"uri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net/vhds/','spapp-osdisk.vhd')]"
						},
						"caching": "ReadWrite",
						"createOption": "FromImage"
					}
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Networking').spappNicName)]"
						}
					]
				},
				"diagnosticsProfile": {
					"bootDiagnostics": {
						"enabled": "true",
						"storageUri": "[concat('http://',variables('storageAccount').storageAccountName,'.blob.core.windows.net')]"
					}
				}
			}
		}
	],
	"outputs": {}
}
